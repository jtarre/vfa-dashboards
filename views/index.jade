extends layout

block content
	h1= title
	h2 Select Fellow
	select#fellow.chosen-select(data-placeholder="Select a Fellow")(tabindex="-1")
		option(value="")
		each id, name in fellowList
			option(id=id) #{name}
	p#selectedFellow
	hr
	h2 Log Notes
	label Subject 
	input(id="subject")(style="width: 250px")
	br
	label Notes 
	textarea(id="notes")(style="width: 250px; height: 75px")
	br
	p#cases
	br
	label User 
	select#vfaList.chosen-select(data-placeholder="Choose Yourself")
		each id, name in vfaList
			option(id=id) #{name}
	br
	br
	button#logNotes(type="button" class="btn btn-success") Log Notes
	p#responseResult
	p#results
	// line break
	hr
	button#updateAccount(type="button" class="btn btn-success") Update Account
	h2 Fellow Info
	h3 Contact Info
	label Email 
	input#Email(type="text")
	br
	label Phone 
	input#Phone(type="text")
	br
	label Bio 
	textarea#Description
	// figure out Birthdate
	hr
	h3 Company Info
	label Company 
	input#Account_Name_for_SurveyGizmo__c("type=text")
	br
	label Website 
	input#Account_Website__c(type="url")
	br
	label Location 
	// figure out chosen select
	br
	label Job Title
	input#Title(type="text")
	h4 Supervisor
	label Manager's First Name
	input#Supervisor_First_Name__c(type="text")
	br
	label Manager's Last Name
	input#Supervisor_Last_Name__c(type="text")
	br
	label Manager's Email
	input#Supervisor_Email__c("type=text")
	hr
	h3 SurveyGizmo Performance Data
	script.
		$(".chosen-select").chosen();
	script.
		// update account data
		$("#updateAccount").click( function(e) {
			// get the id

			var id     = $(#fellow).find('option:selected').attr("id");
			var email  = $("#Email").val();
			var bio    = $("#Description").val();
			var company= $("#Account_Name_for_SurveyGizmo__c").val();
			var website= $("#Account_Website__c").val();
			var title  = $("#Title").val();
			
			var supervisorFirst = $("#Supervisor_First_Name__c").val();
			var supervisorLast  = $("#Supervisor_Last_Name__c").val();
			var supervisorEmail = $("#Supervisor_Email__c").val();

			var fellowData = 
			{
				Id                      : id,
				Email                   : email, 
				Description             : bio,
				Account_Name_for_SurveyGizmo__c : company,
				Account_Website__c      : website,
				Title                   : title,
				Supervisor_First_Name__c: supervisorFirst,
				Supervisor_Last_Name__c : supervisorLast,
				Supervisor_Email__c     : supervisorEmail,

			};
			// store all the data in a variable that can go 
			// right into salesforce
			$.post("fellow-update", { fellowData : fellowData });
		}); 
	script.
		// activity history / cases
		$("#fellow").change(function(e){
			console.log("Here in cases!");
			//e.preventDefault();
			var sfId = $(this).find('option:selected').attr("id");
			console.log("SALESFORCE ID WITHIN CASE CALL: " + sfId);
			$.get("tasks", {id: sfId});
		});
	script.
		// cases 
		$("#fellow").change(function(e){
			console.log("Here in cases!");
			//e.preventDefault();
			var sfId = $(this).find('option:selected').attr("id");
			console.log("SALESFORCE ID WITHIN CASE CALL: " + sfId);
			$.get("cases", {id: sfId}, function ( data ) {
				console.log("SUCESSFULLY RAN GET FUNCTION FOR CASES");
				//console.log("case data: " + data);
				$("#cases").html(data);
			});
		});
	script.
		// account data
		$("#fellow").change(function(e){
			console.log("Here!");
			//e.preventDefault();
			var sfId = $(this).find('option:selected').attr("id");
			console.log(sfId);
			
			var loadingCounter = 1;
			$('#selectedFellow').html("<h4>Loading.</h4>");
			var interval = setInterval( function() {
				console.log("loading counter at start: " + loadingCounter);
				loadingCounter        = loadingCounter + 1;
				console.log("loading counter increment: " + loadingCounter);
				loadingCounterModulo  = loadingCounter % 3;
				console.log("modulo loading counter: " + loadingCounterModulo);

				if ( loadingCounterModulo == 0 ) {
					return $('#selectedFellow').html("<h4>Loading...</h4");
				}

				if ( loadingCounterModulo == 1 ) {
					return $('#selectedFellow').html("<h4>Loading.</h4");
				}

				if ( loadingCounterModulo == 2 ) {
					return $('#selectedFellow').html("<h4>Loading..</h4");
				}
			}, 600);

			$.get("fellows", {id: sfId}, function ( data ) {
				//console.log("data: " + data)
				clearInterval(interval);
				for (key in data) {
					if ($(key).length) {
						if(data[key] !== null) { // make sure we're not trying to input null values
							$(key).val(data[key].toString());
						} else {
							$(key).val("");
						}
					}		
				}
			});
		});
	script.
		$("#logNotes").click(function(e){
			console.log("clicked!");

			var fellowId = $("#fellow").find('option:selected').attr("id");
			console.log("fellow salesforce id: " + fellowId);
			
			var subject    = $("#subject").val();
			var notes      = $("#notes").val();
			var vfaId      = $("#vfaList").find('option:selected').attr("id");
			var relatedTo  = $("#relatedToList").find('option:selected').attr("id");

			// FOR SLACK // 
			var fellowName = $("#fellow").find('option:selected').val();
			var userName   = $("#vfaList").find('option:selected').val();
			
			console.log("subject: " + subject);
			console.log("notes: " + notes);
			console.log("vfa id: " + vfaId);
			console.log("fellow id: ")

			var loadingCounter = 1;
			$("#responseResult").html("<h4>Creating.</h4>");
			var interval = setInterval( function() {
				loadingCounter        = loadingCounter + 1;
				loadingCounterModulo  = loadingCounter % 3;

				if ( loadingCounterModulo == 0 ) {
					return $('#responseResult').html("<h4>Creating...</h4");
				}

				if ( loadingCounterModulo == 1 ) {
					return $('#responseResult').html("<h4>Creating.</h4");
				}

				if ( loadingCounterModulo == 2 ) {
					return $('#responseResult').html("<h4>Creating..</h4");
				}
			}, 600);

			$.post("lognotes", {
				fellowId    : fellowId,
				vfaId       : vfaId,   
				subject     : subject, 
				description : notes,
				relatedTo   : relatedTo,
				fellowName  : fellowName, 
				userName    : userName
			})
			 .done( function ( data ) {
				//alert("Data loaded!: " + data);
				console.log( data );

				clearInterval(interval);
				$('#responseResult').html(data);

				var responseCounter = 0;
				var responseAlert = function () {
					responseCounter = responseCounter + 1;
					if (responseCounter == 1) {
						return $("#responseResult").html("");
					}

					if (responseCounter == 2) {
						clearInterval(responseInterval);
					}
				};
				var responseInterval = setInterval(responseAlert, 2000);
				$("#subject").val("");
				$("#notes").val("");
			});
		})



